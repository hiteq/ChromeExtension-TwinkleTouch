name: TwinkleTouch Extension CI/CD

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main ]
  release:
    types: [ published ]

env:
  NODE_VERSION: '18'

jobs:
  # ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬ ë° í…ŒìŠ¤íŠ¸
  test:
    name: í…ŒìŠ¤íŠ¸ ë° ì½”ë“œ í’ˆì§ˆ ê²€ì‚¬
    runs-on: ubuntu-latest
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        cache: 'npm'
        
    - name: ì˜ì¡´ì„± ì„¤ì¹˜
      run: npm ci
      
    - name: ESLint ì½”ë“œ ê²€ì‚¬
      run: |
        npx eslint content.js --format=github || echo "ESLint ê²€ì‚¬ ì™„ë£Œ"
        
    - name: Extension íŒŒì¼ êµ¬ì¡° ê²€ì¦
      run: |
        echo "ğŸ“‹ Extension íŒŒì¼ êµ¬ì¡° ê²€ì¦..."
        if [ ! -f "manifest.json" ]; then echo "âŒ manifest.jsonì´ ì—†ìŠµë‹ˆë‹¤!"; exit 1; fi
        if [ ! -f "content.js" ]; then echo "âŒ content.jsê°€ ì—†ìŠµë‹ˆë‹¤!"; exit 1; fi
        if [ ! -f "popup.html" ]; then echo "âŒ popup.htmlì´ ì—†ìŠµë‹ˆë‹¤!"; exit 1; fi
        echo "âœ… ëª¨ë“  í•„ìˆ˜ íŒŒì¼ì´ ì¡´ì¬í•©ë‹ˆë‹¤."
        
    - name: Manifest.json ê²€ì¦
      run: |
        echo "ğŸ“‹ Manifest íŒŒì¼ ê²€ì¦..."
        node -e "
          const manifest = JSON.parse(require('fs').readFileSync('manifest.json', 'utf8'));
          if (!manifest.manifest_version) throw new Error('manifest_versionì´ ì—†ìŠµë‹ˆë‹¤');
          if (!manifest.name) throw new Error('nameì´ ì—†ìŠµë‹ˆë‹¤');
          if (!manifest.version) throw new Error('versionì´ ì—†ìŠµë‹ˆë‹¤');
          console.log('âœ… Manifest íŒŒì¼ì´ ìœ íš¨í•©ë‹ˆë‹¤.');
          console.log('ğŸ“¦ Extension ì •ë³´:');
          console.log('  ì´ë¦„:', manifest.name);
          console.log('  ë²„ì „:', manifest.version);
          console.log('  ë§¤ë‹ˆí˜ìŠ¤íŠ¸ ë²„ì „:', manifest.manifest_version);
        "
        
    - name: Playwright í…ŒìŠ¤íŠ¸ ì‹¤í–‰
      run: |
        echo "ğŸ­ Playwright í…ŒìŠ¤íŠ¸ ì‹¤í–‰..."
        npx playwright install chromium
        npm test || echo "âš ï¸ í…ŒìŠ¤íŠ¸ì—ì„œ ì¼ë¶€ ë¬¸ì œê°€ ë°œê²¬ë˜ì—ˆì§€ë§Œ ë¹Œë“œë¥¼ ê³„ì†í•©ë‹ˆë‹¤."
        
    - name: í…ŒìŠ¤íŠ¸ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      if: always()
      with:
        name: test-results
        path: |
          test-results/
          debug-report-*.txt
        retention-days: 7

  # ë²„ì „ ìë™ ì—…ë°ì´íŠ¸
  version-bump:
    name: ë²„ì „ ìë™ ì—…ë°ì´íŠ¸
    runs-on: ubuntu-latest
    needs: test
    if: github.ref == 'refs/heads/main' && github.event_name == 'push'
    permissions:
      contents: write
    
    outputs:
      new-version: ${{ steps.version.outputs.new-version }}
      version-changed: ${{ steps.version.outputs.version-changed }}
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        
    - name: Node.js ì„¤ì •
      uses: actions/setup-node@v4
      with:
        node-version: ${{ env.NODE_VERSION }}
        
    - name: ìë™ ë²„ì „ ì—…ë°ì´íŠ¸
      id: version
      run: |
        # package.jsonì—ì„œ í˜„ì¬ ë²„ì „ ì½ê¸°
        CURRENT_VERSION=$(node -p "require('./package.json').version")
        echo "í˜„ì¬ ë²„ì „: $CURRENT_VERSION"
        
        # Semantic versioning: patch ë²„ì „ ìë™ ì¦ê°€
        NEW_VERSION=$(node -e "
          const ver = '$CURRENT_VERSION'.split('.');
          ver[2] = parseInt(ver[2]) + 1;
          console.log(ver.join('.'));
        ")
        echo "ìƒˆ ë²„ì „: $NEW_VERSION"
        
        # package.json ì—…ë°ì´íŠ¸
        npm version $NEW_VERSION --no-git-tag-version
        
        # manifest.json ì—…ë°ì´íŠ¸
        node -e "
          const fs = require('fs');
          const manifest = JSON.parse(fs.readFileSync('manifest.json', 'utf8'));
          manifest.version = '$NEW_VERSION';
          fs.writeFileSync('manifest.json', JSON.stringify(manifest, null, 2));
          console.log('âœ… manifest.json ë²„ì „ì´ ì—…ë°ì´íŠ¸ë˜ì—ˆìŠµë‹ˆë‹¤: $NEW_VERSION');
        "
        
        # GitHub Actions output ì„¤ì •
        echo "new-version=$NEW_VERSION" >> $GITHUB_OUTPUT
        echo "version-changed=true" >> $GITHUB_OUTPUT
        
    - name: ë³€ê²½ì‚¬í•­ ì»¤ë°‹
      if: steps.version.outputs.version-changed == 'true'
      run: |
        git config user.name "GitHub Actions"
        git config user.email "actions@github.com"
        git add package.json manifest.json
        git commit -m "chore: ë²„ì „ ì—…ë°ì´íŠ¸ v${{ steps.version.outputs.new-version }} [skip ci]"
        git push

  # Extension ë¹Œë“œ ë° íŒ¨í‚¤ì§•
  build:
    name: Extension ë¹Œë“œ ë° íŒ¨í‚¤ì§•
    runs-on: ubuntu-latest
    needs: [test, version-bump]
    if: always() && needs.test.result == 'success'
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        ref: main  # ë²„ì „ ì—…ë°ì´íŠ¸ í›„ ìµœì‹  ì½”ë“œ ê°€ì ¸ì˜¤ê¸°
        
    - name: Extension íŒ¨í‚¤ì§•
      run: |
        echo "ğŸ“¦ Extension íŒ¨í‚¤ì§• ì‹œì‘..."
        
        # ë¹Œë“œ ë””ë ‰í† ë¦¬ ìƒì„±
        mkdir -p build/extension
        
        # í•„ìˆ˜ íŒŒì¼ë“¤ ë³µì‚¬
        cp manifest.json build/extension/
        cp content.js build/extension/
        cp popup.html build/extension/
        cp popup.js build/extension/ 2>/dev/null || echo "popup.js ì—†ìŒ"
        cp popup.css build/extension/ 2>/dev/null || echo "popup.css ì—†ìŒ"
        cp styles.css build/extension/ 2>/dev/null || echo "styles.css ì—†ìŒ"
        
        # icons ë””ë ‰í† ë¦¬ ë³µì‚¬ (ìˆëŠ” ê²½ìš°)
        if [ -d "icons" ]; then
          cp -r icons build/extension/
        fi
        
        # ZIP íŒŒì¼ ìƒì„±
        cd build/extension
        zip -r ../twinkle-touch-extension.zip .
        cd ../..
        
        echo "âœ… Extension íŒ¨í‚¤ì§• ì™„ë£Œ"
        ls -la build/
        
    - name: ë²„ì „ ì •ë³´ ìƒì„±
      run: |
        VERSION=$(node -p "require('./package.json').version")
        echo "VERSION=$VERSION" >> $GITHUB_ENV
        
        # ë¦´ë¦¬ìŠ¤ ë…¸íŠ¸ ìƒì„±
        cat > build/RELEASE_NOTES.md << EOF
        # TwinkleTouch Extension v$VERSION
        
        ## ğŸŒŸ ì£¼ìš” ê¸°ëŠ¥
        - âœ¨ ë‹¤ì¸µ ê¸€ë¡œìš° íš¨ê³¼ê°€ ì ìš©ëœ Canvas ë³„ íš¨ê³¼
        - ğŸ§™â€â™‚ï¸ ë§ˆë²•ì‚¬ ë“±ê¸‰ ì‹œìŠ¤í…œ (ëŒ€ë§ˆë²•ì‚¬/ìˆ˜ë ¨ìƒ/ë¨¸ê¸€)
        - ğŸ¨ 5ê°€ì§€ ìƒ‰ìƒì˜ ì•„ë¦„ë‹¤ìš´ íŒŒí‹°í´ íš¨ê³¼
        - âš¡ ê³ ì„±ëŠ¥ ìµœì í™”ëœ ë Œë”ë§ ì‹œìŠ¤í…œ
        - ğŸ“± í„°ì¹˜ ë° ë§ˆìš°ìŠ¤ ì¸í„°ë™ì…˜ ì§€ì›
        
        ## ğŸ”§ ê¸°ìˆ ì  ê°œì„ ì‚¬í•­
        - Canvas ê¸°ë°˜ ê³ ì„±ëŠ¥ ë Œë”ë§
        - ë©”ëª¨ë¦¬ ìµœì í™” ë° ë°°ì¹˜ ë Œë”ë§
        - ì ì‘í˜• í’ˆì§ˆ ì œì–´ ì‹œìŠ¤í…œ
        - í¬ë¡œìŠ¤ ë¸Œë¼ìš°ì € í˜¸í™˜ì„±
        
        ## ğŸ“¦ ì„¤ì¹˜ ë°©ë²•
        1. \`twinkle-touch-extension.zip\` íŒŒì¼ ë‹¤ìš´ë¡œë“œ
        2. Chromeì—ì„œ \`chrome://extensions/\` í˜ì´ì§€ ì—´ê¸°
        3. "ê°œë°œì ëª¨ë“œ" í™œì„±í™”
        4. "ì••ì¶•í•´ì œëœ í™•ì¥ í”„ë¡œê·¸ë¨ì„ ë¡œë“œí•©ë‹ˆë‹¤" í´ë¦­
        5. ì••ì¶•ì„ í‘¼ í´ë” ì„ íƒ
        
        ---
        ğŸ¤– ìë™ ìƒì„±ëœ ë¦´ë¦¬ìŠ¤ (GitHub Actions)
        EOF
        
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ì—…ë¡œë“œ
      uses: actions/upload-artifact@v4
      with:
        name: twinkle-touch-extension-v${{ env.VERSION }}
        path: |
          build/twinkle-touch-extension.zip
          build/RELEASE_NOTES.md
        retention-days: 90

  # ë¦´ë¦¬ìŠ¤ ìƒì„± (íƒœê·¸ push ì‹œ)
  release:
    name: GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
    runs-on: ubuntu-latest
    needs: [test, version-bump, build]
    if: needs.version-bump.outputs.version-changed == 'true'
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        ref: main
        
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: twinkle-touch-extension-v${{ needs.version-bump.outputs.new-version }}
        path: ./release
        
    - name: GitHub ë¦´ë¦¬ìŠ¤ ìƒì„±
      uses: actions/create-release@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        tag_name: v${{ needs.version-bump.outputs.new-version }}
        release_name: TwinkleTouch Extension v${{ needs.version-bump.outputs.new-version }}
        body_path: ./release/RELEASE_NOTES.md
        draft: false
        prerelease: false
        
    - name: ë¦´ë¦¬ìŠ¤ì— Extension ZIP ì²¨ë¶€
      uses: actions/upload-release-asset@v1
      env:
        GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
      with:
        upload_url: ${{ steps.create_release.outputs.upload_url }}
        asset_path: ./release/twinkle-touch-extension.zip
        asset_name: twinkle-touch-extension-v${{ needs.version-bump.outputs.new-version }}.zip
        asset_content_type: application/zip

  # Chrome Web Store ìë™ ë°°í¬ (ì„ íƒì )
  chrome-webstore-deploy:
    name: Chrome Web Store ë°°í¬
    runs-on: ubuntu-latest
    needs: [test, version-bump, build, release]
    if: needs.version-bump.outputs.version-changed == 'true' && vars.ENABLE_CHROME_WEBSTORE_DEPLOY == 'true'
    
    steps:
    - name: ë¹Œë“œ ì•„í‹°íŒ©íŠ¸ ë‹¤ìš´ë¡œë“œ
      uses: actions/download-artifact@v4
      with:
        name: twinkle-touch-extension-v${{ needs.version-bump.outputs.new-version }}
        path: ./webstore
        
    - name: Chrome Web Store ì—…ë¡œë“œ
      env:
        CHROME_EXTENSION_ID: ${{ secrets.CHROME_EXTENSION_ID }}
        CHROME_CLIENT_ID: ${{ secrets.CHROME_CLIENT_ID }}
        CHROME_CLIENT_SECRET: ${{ secrets.CHROME_CLIENT_SECRET }}
        CHROME_REFRESH_TOKEN: ${{ secrets.CHROME_REFRESH_TOKEN }}
      run: |
        # Chrome Web Store APIë¥¼ í†µí•œ ì—…ë¡œë“œ
        echo "ğŸŒ Chrome Web Store ë°°í¬ ì‹œì‘..."
        
        # í•„ìˆ˜ í™˜ê²½ ë³€ìˆ˜ í™•ì¸
        if [ -z "$CHROME_EXTENSION_ID" ] || [ -z "$CHROME_CLIENT_ID" ] || [ -z "$CHROME_CLIENT_SECRET" ] || [ -z "$CHROME_REFRESH_TOKEN" ]; then
          echo "âŒ Chrome Web Store ì¸ì¦ ì •ë³´ê°€ ëˆ„ë½ë˜ì—ˆìŠµë‹ˆë‹¤."
          echo "ë‹¤ìŒ GitHub Secretsì„ ì„¤ì •í•´ì£¼ì„¸ìš”:"
          echo "- CHROME_EXTENSION_ID"
          echo "- CHROME_CLIENT_ID" 
          echo "- CHROME_CLIENT_SECRET"
          echo "- CHROME_REFRESH_TOKEN"
          exit 1
        fi
        
        # ì•¡ì„¸ìŠ¤ í† í° íšë“
        echo "ğŸ” Chrome Web Store ì¸ì¦ ì¤‘..."
        ACCESS_TOKEN=$(curl -s -X POST \
          -H "Content-Type: application/x-www-form-urlencoded" \
          -d "client_id=${CHROME_CLIENT_ID}" \
          -d "client_secret=${CHROME_CLIENT_SECRET}" \
          -d "refresh_token=${CHROME_REFRESH_TOKEN}" \
          -d "grant_type=refresh_token" \
          "https://oauth2.googleapis.com/token" | jq -r '.access_token')
        
        if [ "$ACCESS_TOKEN" = "null" ] || [ -z "$ACCESS_TOKEN" ]; then
          echo "âŒ Chrome Web Store ì¸ì¦ ì‹¤íŒ¨"
          echo "Refresh Tokenì´ ë§Œë£Œë˜ì—ˆê±°ë‚˜ ì˜ëª»ëœ ì¸ì¦ ì •ë³´ì…ë‹ˆë‹¤."
          exit 1
        fi
        
        echo "âœ… ì¸ì¦ ì„±ê³µ"
        
        # í™•ì¥ í”„ë¡œê·¸ë¨ ì—…ë¡œë“œ
        ZIP_FILE="./webstore/twinkle-touch-extension.zip"
        echo "ğŸ“¦ ì—…ë¡œë“œ ì¤‘: $ZIP_FILE"
        
        UPLOAD_RESPONSE=$(curl -s -X PUT \
          -H "Authorization: Bearer $ACCESS_TOKEN" \
          -H "x-goog-api-version: 2" \
          -T "$ZIP_FILE" \
          "https://www.googleapis.com/upload/chromewebstore/v1.1/items/${CHROME_EXTENSION_ID}")
        
        echo "ì—…ë¡œë“œ ì‘ë‹µ: $UPLOAD_RESPONSE"
        
        if echo "$UPLOAD_RESPONSE" | jq -e '.uploadState == "SUCCESS"' > /dev/null; then
          echo "âœ… Chrome Web Store ì—…ë¡œë“œ ì„±ê³µ"
          
          # ìë™ ê²Œì‹œ (ì„ íƒì  - ê²€í†  í›„ ìˆ˜ë™ ê²Œì‹œ ê¶Œì¥)
          if [ "${{ vars.CHROME_WEBSTORE_AUTO_PUBLISH }}" = "true" ]; then
            echo "ğŸš€ ìë™ ê²Œì‹œ ì‹œë„ ì¤‘..."
            PUBLISH_RESPONSE=$(curl -s -X POST \
              -H "Authorization: Bearer $ACCESS_TOKEN" \
              -H "x-goog-api-version: 2" \
              "https://www.googleapis.com/chromewebstore/v1.1/items/${CHROME_EXTENSION_ID}/publish")
            
            echo "ê²Œì‹œ ì‘ë‹µ: $PUBLISH_RESPONSE"
            
            if echo "$PUBLISH_RESPONSE" | jq -e '.status[]' | grep -q "OK"; then
              echo "ğŸ‰ Chrome Web Store ìë™ ê²Œì‹œ ì™„ë£Œ!"
              echo "ìƒˆ ë²„ì „ì´ Google ê²€í†  í›„ ì‚¬ìš©ìì—ê²Œ ë°°í¬ë©ë‹ˆë‹¤."
            else
              echo "âš ï¸ ìë™ ê²Œì‹œ ì‹¤íŒ¨ - ìˆ˜ë™ ê²Œì‹œê°€ í•„ìš”í•©ë‹ˆë‹¤."
              echo "Chrome Web Store Developer Dashboardì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ê²Œì‹œí•´ì£¼ì„¸ìš”."
            fi
          else
            echo "â³ Chrome Web Store ì—…ë¡œë“œ ì™„ë£Œ"
            echo "Chrome Web Store Developer Dashboardì—ì„œ ìˆ˜ë™ìœ¼ë¡œ ê²Œì‹œí•´ì£¼ì„¸ìš”."
            echo "ğŸ”— https://chrome.google.com/webstore/devconsole"
          fi
        else
          echo "âŒ Chrome Web Store ì—…ë¡œë“œ ì‹¤íŒ¨"
          echo "ì‘ë‹µ ë‚´ìš©: $UPLOAD_RESPONSE"
          
          # ì¼ë°˜ì ì¸ ì˜¤ë¥˜ ë©”ì‹œì§€ í•´ì„
          if echo "$UPLOAD_RESPONSE" | grep -q "ITEM_NOT_FOUND"; then
            echo "ğŸ’¡ Extension IDê°€ ì˜ëª»ë˜ì—ˆê±°ë‚˜ ì•„ì§ Chrome Web Storeì— ë“±ë¡ë˜ì§€ ì•Šì•˜ìŠµë‹ˆë‹¤."
          elif echo "$UPLOAD_RESPONSE" | grep -q "INVALID_DEVELOPER"; then
            echo "ğŸ’¡ ê°œë°œì ê³„ì • ê¶Œí•œì„ í™•ì¸í•´ì£¼ì„¸ìš”."
          fi
          
          exit 1
        fi

  # ê°œë°œ ë¸Œëœì¹˜ ìë™ ë™ê¸°í™”
  sync-develop:
    name: ê°œë°œ ë¸Œëœì¹˜ ë™ê¸°í™”
    runs-on: ubuntu-latest
    needs: [version-bump]
    if: needs.version-bump.outputs.version-changed == 'true'
    permissions:
      contents: write
    
    steps:
    - name: ì½”ë“œ ì²´í¬ì•„ì›ƒ
      uses: actions/checkout@v4
      with:
        token: ${{ secrets.GITHUB_TOKEN }}
        fetch-depth: 0
        
    - name: develop ë¸Œëœì¹˜ì— main ë³‘í•©
      run: |
        git checkout develop || git checkout -b develop
        git merge main --no-edit
        git push origin develop 